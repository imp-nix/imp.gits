#!/usr/bin/env bash
set -euo pipefail

# git-bits: Multi-repo workspace composition
# Usage: git bits <command> [args]

GITBITS_DIR=".gitbits"
CONFIG_FILE=".gitbits/config.nix"

# Set by wrapper during nix build
GITBITS_LIB="${GITBITS_LIB:-@gitbitsLib@}"

show_help() {
  cat <<EOF
Usage: git bits <command> [args]

Commands:
  init          Initialize workspace from $CONFIG_FILE
  status        Show status of all repos
  pull [--force] Pull updates for all injections (--force: reset to remote)
  push          Push changes to injection remotes
  use <name>    Switch git context to an injection (or 'main')
  exit          Exit injection context (alias for 'use main')
  list          List available contexts
  help          Show this help

Context switching:
  bash/zsh:  eval "\$(git bits use <name>)"
  fish:      eval (git bits use <name>)
  nushell:   git bits use <name> | from json | load-env

Config file ($CONFIG_FILE):
  {
    injections = [
      {
        name = "my-lib";
        remote = "https://github.com/org/lib.git";
        use = [ "lib" "tools" ];
      }
    ];
  }

Injections are applied in order - later entries override earlier ones.
EOF
}

require_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: $CONFIG_FILE not found" >&2
    exit 1
  fi
}

require_git() {
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: not a git repository" >&2
    exit 1
  fi
}

eval_script() {
  local script_name="$1"
  nix-instantiate --eval --strict --json -E "
    let
      lib = import <nixpkgs/lib>;
      gitbits = import $GITBITS_LIB { inherit lib; };
      config = import ./$CONFIG_FILE;
    in (gitbits.build config).scripts.$script_name
  " 2>/dev/null | jq -r '.'
}

run_script() {
  local script_name="$1"
  shift
  local script
  script=$(eval_script "$script_name")
  if [[ -z "$script" ]]; then
    echo "Error: failed to generate $script_name script" >&2
    exit 1
  fi
  bash -c "$script" -- "$@"
}

cmd_init() {
  require_config
  require_git
  run_script "init"
}

cmd_status() {
  require_config
  require_git
  run_script "status"
}

cmd_pull() {
  require_config
  require_git
  if [[ "${1:-}" == "--force" ]] || [[ "${1:-}" == "-f" ]]; then
    run_script "pull-force"
  else
    run_script "pull"
  fi
}

cmd_push() {
  require_config
  require_git
  run_script "push"
}

cmd_use() {
  require_config
  local context="${1:-main}"
  local script
  script=$(eval_script "use")
  bash -c "$script" -- "$context"
}

cmd_exit() {
  # Detect parent shell by walking up process tree
  detect_shell() {
    local pid=$PPID
    while [ "$pid" != "1" ] && [ -n "$pid" ]; do
      local comm=$(cat /proc/$pid/comm 2>/dev/null || echo "")
      case "$comm" in
        fish|nu|bash|zsh) echo "$comm"; return ;;
      esac
      pid=$(cut -d' ' -f4 /proc/$pid/stat 2>/dev/null || echo "1")
    done
    echo "unknown"
  }
  local shell=$(detect_shell)
  case "$shell" in
    fish)
      echo "set -e GIT_DIR; set -e GIT_WORK_TREE"
      ;;
    nu)
      echo '{"GIT_DIR": null, "GIT_WORK_TREE": null}'
      ;;
    *)
      echo "unset GIT_DIR GIT_WORK_TREE"
      ;;
  esac
}

cmd_list() {
  require_config
  local script
  script=$(eval_script "use")
  bash -c "$script" -- list
}

case "${1:-help}" in
  init)   cmd_init ;;
  status) cmd_status ;;
  pull)   cmd_pull "${2:-}" ;;
  push)   cmd_push ;;
  use)    cmd_use "${2:-}" ;;
  exit)   cmd_exit ;;
  list)   cmd_list ;;
  -h|--help|help) show_help ;;
  *)
    echo "Unknown command: $1" >&2
    echo "Run 'git bits help' for usage" >&2
    exit 1
    ;;
esac
